name: NOBIXRDP

on:
  workflow_dispatch:
    inputs:
      replace_slot:
        description: "Slot to replace (RDP-1 to RDP-5)"
        required: false
        default: ""

jobs:
  rdp:
    runs-on: windows-latest

    steps:

    # ------------------------------------------------------------
    # Allocate Slot (Replacement-aware)
    # ------------------------------------------------------------
    - name: Allocate RDP Slot
      shell: pwsh
      run: |
        $incoming = "${{ github.event.inputs.replace_slot }}"

        if ($incoming -ne "") {
          echo "RDP_SLOT=$incoming" >> $env:GITHUB_ENV
          echo "REPLACED=$incoming" >> $env:GITHUB_ENV
          exit 0
        }

        $headers = @{
          Authorization = "Bearer ${{ secrets.GH_TRIGGER_TOKEN }}"
          Accept        = "application/vnd.github+json"
        }

        $repo = "${{ github.repository }}"

        $runs = Invoke-RestMethod `
          -Headers $headers `
          -Uri "https://api.github.com/repos/$repo/actions/runs?status=in_progress"

        $active = $runs.workflow_runs | Where-Object { $_.name -eq "NOBIXRDP" }

        if ($active.Count -ge 5) {
          $oldest = $active | Sort-Object created_at | Select-Object -First 1
          Invoke-RestMethod -Method POST -Headers $headers `
            -Uri "https://api.github.com/repos/$repo/actions/runs/$($oldest.id)/cancel"
        }

        $slot = ($active.Count % 5) + 1
        echo "RDP_SLOT=RDP-$slot" >> $env:GITHUB_ENV

    # ------------------------------------------------------------
    # Enable RDP
    # ------------------------------------------------------------
    - name: Enable RDP
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' fDenyTSConnections 0
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' UserAuthentication 0
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' SecurityLayer 0
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        Restart-Service TermService -Force

    # ------------------------------------------------------------
    # Create User (Fixed Password)
    # ------------------------------------------------------------
    - name: Create User
      run: |
        $pass="${{ secrets.RDP_PASSWORD }}"
        $sec=ConvertTo-SecureString $pass -AsPlainText -Force

        if (Get-LocalUser NOBIXRDP -ErrorAction SilentlyContinue) {
          Set-LocalUser NOBIXRDP -Password $sec
        } else {
          New-LocalUser NOBIXRDP -Password $sec -AccountNeverExpires
          Add-LocalGroupMember Administrators NOBIXRDP
          Add-LocalGroupMember "Remote Desktop Users" NOBIXRDP
        }

    # ------------------------------------------------------------
    # Install & Connect Tailscale
    # ------------------------------------------------------------
    - name: Tailscale
      run: |
        $u="https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $p="$env:TEMP\tailscale.msi"
        Invoke-WebRequest $u -OutFile $p
        Start-Process msiexec "/i `"$p`" /quiet" -Wait
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}

        $ip=""
        while (-not $ip) {
          $ip=& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          Start-Sleep 5
        }
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

    # ------------------------------------------------------------
    # Telegram: NEW / REPLACED RDP
    # ------------------------------------------------------------
    - name: Telegram New RDP
      run: |
        $bot="${{ secrets.TG_BOT_TOKEN }}"
        $chat="${{ secrets.TG_CHAT_ID }}"

        if ($env:REPLACED) {
          $msg="üü¢ **NEW RDP READY**%0AüîÅ Replaced: **$env:REPLACED**%0Aüî¢ Slot: **$env:RDP_SLOT**%0Aüñ• IP: $env:TAILSCALE_IP%0Aüë§ Login: localhost\NOBIXRDP%0Aüîê Password: FIXED"
        } else {
          $msg="üü¢ **NEW RDP READY**%0Aüî¢ Slot: **$env:RDP_SLOT**%0Aüñ• IP: $env:TAILSCALE_IP%0Aüë§ Login: localhost\NOBIXRDP%0Aüîê Password: FIXED"
        }

        Invoke-RestMethod "https://api.telegram.org/bot$bot/sendMessage?chat_id=$chat&text=$msg"

    # ------------------------------------------------------------
    # Lifetime ‚Üí Warning ‚Üí Immediate Replacement Trigger
    # ------------------------------------------------------------
    - name: Lifetime & Auto Replace
      shell: pwsh
      run: |
        $bot="${{ secrets.TG_BOT_TOKEN }}"
        $chat="${{ secrets.TG_CHAT_ID }}"

        # 5h45m
        Start-Sleep 20700

        Invoke-RestMethod "https://api.telegram.org/bot$bot/sendMessage?chat_id=$chat&text=‚è∞ **WARNING**%0A$env:RDP_SLOT will be replaced in 15 minutes"

        # Trigger replacement NOW
        $body = @{
          ref = "${{ github.ref }}"
          inputs = @{
            replace_slot = "$env:RDP_SLOT"
          }
        } | ConvertTo-Json -Depth 5

        Invoke-RestMethod `
          -Method POST `
          -Uri "https://api.github.com/repos/${{ github.repository }}/actions/workflows/NOBIXRDP.yml/dispatches" `
          -Headers @{
            Authorization = "Bearer ${{ secrets.GH_TRIGGER_TOKEN }}"
            Accept = "application/vnd.github+json"
          } `
          -Body $body

        # Final 15 min
        Start-Sleep 900
