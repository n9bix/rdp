name: NOBIXRDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    # ------------------------------------------------------------
    # Decide RDP SLOT (1‚Äì5) + Cleanup Oldest if needed
    # ------------------------------------------------------------
    - name: Allocate RDP Slot
      shell: pwsh
      run: |
        $headers = @{
          Authorization = "Bearer ${{ secrets.GH_TRIGGER_TOKEN }}"
          Accept        = "application/vnd.github+json"
        }

        $repo = "${{ github.repository }}"
        $wf   = "NOBIXRDP.yml"

        $runs = Invoke-RestMethod `
          -Headers $headers `
          -Uri "https://api.github.com/repos/$repo/actions/workflows/$wf/runs?status=in_progress"

        if ($runs.total_count -ge 5) {
          $oldest = $runs.workflow_runs | Sort-Object created_at | Select-Object -First 1

          Invoke-RestMethod `
            -Method POST `
            -Headers $headers `
            -Uri "https://api.github.com/repos/$repo/actions/runs/$($oldest.id)/cancel"

          $bot="${{ secrets.TG_BOT_TOKEN }}"
          $chat="${{ secrets.TG_CHAT_ID }}"
          $msg="üßπ OLD RDP CANCELLED%0AüÜî Run ID: $($oldest.id)"
          Invoke-RestMethod "https://api.telegram.org/bot$bot/sendMessage?chat_id=$chat&text=$msg"
        }

        $slot = ($runs.total_count % 5) + 1
        echo "RDP_SLOT=RDP-$slot" >> $env:GITHUB_ENV

    # ------------------------------------------------------------
    # Enable RDP
    # ------------------------------------------------------------
    - name: Enable RDP
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' fDenyTSConnections 0
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        Restart-Service TermService -Force

    # ------------------------------------------------------------
    # Create RDP User (FIXED PASSWORD)
    # ------------------------------------------------------------
    - name: Create User
      run: |
        $pass="${{ secrets.RDP_PASSWORD }}"
        $sec=ConvertTo-SecureString $pass -AsPlainText -Force

        if (Get-LocalUser NOBIXRDP -ErrorAction SilentlyContinue) {
          Set-LocalUser NOBIXRDP -Password $sec
        } else {
          New-LocalUser NOBIXRDP -Password $sec -AccountNeverExpires
          Add-LocalGroupMember Administrators NOBIXRDP
          Add-LocalGroupMember "Remote Desktop Users" NOBIXRDP
        }

        echo "RDP_USER=NOBIXRDP" >> $env:GITHUB_ENV

    # ------------------------------------------------------------
    # Install + Start Tailscale
    # ------------------------------------------------------------
    - name: Tailscale
      run: |
        $u="https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $p="$env:TEMP\tailscale.msi"
        Invoke-WebRequest $u -OutFile $p
        Start-Process msiexec "/i `"$p`" /quiet" -Wait
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
        $ip=""
        while (-not $ip) {
          $ip=& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          Start-Sleep 5
        }
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

    # ------------------------------------------------------------
    # Telegram: NEW RDP DETAILS
    # ------------------------------------------------------------
    - name: Telegram New RDP
      run: |
        $bot="${{ secrets.TG_BOT_TOKEN }}"
        $chat="${{ secrets.TG_CHAT_ID }}"
        $msg="üü¢ **NEW RDP READY**%0A%0Aüî¢ $env:RDP_SLOT%0Aüñ• IP: $env:TAILSCALE_IP%0Aüë§ User: NOBIXRDP%0Aüîê Pass: FIXED%0A‚è≥ Expiry: 6 HOURS"
        Invoke-RestMethod "https://api.telegram.org/bot$bot/sendMessage?chat_id=$chat&text=$msg"

    # ------------------------------------------------------------
    # EXPIRY COUNTDOWN + ALERTS
    # ------------------------------------------------------------
    - name: RDP Lifetime
      run: |
        $bot="${{ secrets.TG_BOT_TOKEN }}"
        $chat="${{ secrets.TG_CHAT_ID }}"

        Start-Sleep 20700   # 5h 45m

        Invoke-RestMethod "https://api.telegram.org/bot$bot/sendMessage?chat_id=$chat&text=‚è∞ WARNING%0A$env:RDP_SLOT will expire in 15 minutes"

        Start-Sleep 900     # 15m

        Invoke-RestMethod "https://api.telegram.org/bot$bot/sendMessage?chat_id=$chat&text=üî¥ RDP EXPIRED%0A$env:RDP_SLOT is now offline"
